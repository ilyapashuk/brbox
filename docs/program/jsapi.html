<html><body>
<h1>javascript api команды prepair</h1>
<p>для команды prepair можно писать собственные обработчики на языке Javascript. <br />
<p>для интерпретации js используется библиотека github.com/dop251/goja, которая реализует стандарт es5.1 и некоторые возможности из es6. <br />
<p>помимо стандартной библиотеки js пользователю доступно следующее api:
<ul>
<li>функции getenv, setenv, unsetenv и lookupEnv позволяют получать доступ к списку переменных среды процесса brbox, который в данный момент используется в качестве хранилища параметров конфигурации. <br />
внимание: в будущем механизмы работы с конфигурацией, вероятно, изменятся вместе с этим api.
<li>функция ListHandlers возвращает строковый массив со списком всех зарегистрированных обработчиков.
<li>функция CallHandler(text,handlername,args) позволяет скрипту вызвать другой обработчик с любыми аргументами, передав ему весь текст или его часть. аргументы надо передать как массив строк.
<li>функция-конструктор StringsBuilder даёт js-коду доступ к Go-объекту strings.Builder, который может быть полезен при работе с текстом. <br />
обратите внимание: если ваш скрипт работает так, что его конечный результат оказывается записан в stringsBuilder, и требуется вернуть результат вызова sb.String(), то надо вернуть сам объект builder. <br />
это связано с тем, что в js строка представлена в UTF16, а в Go - в UTF8, и каждый раз, когда строковые значения передаются между двумя средами, происходит конвертирование из одного формата в другой. если для возврата написать sb.String(), то произойдёт следующее: js вызовет функцию String, её результат будет преобразован в utf16, а потом произойдёт выход из скрипта, и его результат опять будет сконвертирован, что точно является нерациональным использованием ресурсов, поэтому предусмотрена возможность возвращать builder напрямую.
<li>print: вывод данных в консоль.
<li>charToDots: выводит символ, соответствующий в таблице bxt указанному брайлевскому знаку. знак следует передавать в виде строкового описания точек, например, 12.
</ul>
<p>обработчики для этого api должны быть помещены в подкаталог prepair.handlers каталога конфигурации.
<p>обработчики будут получать текст построчно.
<p>на верхнем уровне должны быть определены все вспомогательные функции и константы, которые будут инициализированы при первом вызове обработчика.
<p>также на верхнем уровне должна быть определена функция handle, в которую и будут направляться строки текста.
<p>в эту функцию будут переданы два аргумента: собственно строка и строковый массив аргументов, может быть пустым.
<p>функция должна вернуть либо обработанный текст, либо значение false, во втором случае строка будет полностью отброшена.
</body></html>